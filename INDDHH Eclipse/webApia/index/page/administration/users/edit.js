function initPage(){
	//crear spinner de espere un momento
	sp = new Spinner(document.body,{message:WAIT_A_SECOND});
		
	//mostrar la caja "todos lso ambientes" si:
	//-el usuario es para todos los ambientes
	//-se está creando un usuario global
	if(isAllEnvs || (isGlobal && isCreate)){
		addActionElementAdmin($('environmentsContainter'), LBL_ALL_ENVS,"allEnvs","true",false,null);
	}
	
	var optionDeleteDateLastLogin = $('optionDeleteDateLastLogin');
	optionDeleteDateLastLogin.addEvent('click', function(evt){
		$('chkResetLastLogin').value = "true";
		$('usrLastLogin').value = "";
	});
	
	if(isGlobal){
		//cargar ambientes
		loadEnvs();
	}
	
	//cargar grupos
	loadPools();
	//cargar perfiles
	loadProfiles();
	//cargar roles organizacionales
	loadOrgRoles();
	
	if(isGlobal){
		$('environmentsContainter').onRemove=function(objId){
			//si al remover, no queda nada, se muestra el "todos los ambientes"
			var arr = getActionElementsIds($('environmentsContainter'));
			if(arr.length==0){
				var allEnvs = $('allEnvs');
				if(allEnvs) allEnvs.setStyle("display",'');
			}
		}
		
		$('addEnvironment').addEvent("click", function(e) {
			e.stop();
			showEnvironmentsModal(processEnvsModalReturn);
		});
	}
	
	$('addProfile').addEvent("click", function(e) {
		e.stop();
		//PROFILEMODAL_SHOWGLOBAL = true;
		PROFILEMODAL_SHOWGLOBAL = isGlobal;
		
		if(!isGlobal){
			PROFILEMODAL_FROMENVS = currentEnvId;
		}else {
			PROFILEMODAL_FROMENVS=arrayToString(getActionElementsIds($('environmentsContainter')));
		}
		showProfilesModal(processProfilesModalReturn);
	});
	
	$('addPool').addEvent("click", function(e) {
		e.stop();
		//setear variables de configuracion del modal de grupos
		POOLMODAL_SHOWAUTOGENERATED = false;
		POOLMODAL_SHOWNOTAUTOGENERATED = true;
		//POOLMODAL_SHOWGLOBAL = true;
		
		POOLMODAL_SHOWGLOBAL = isGlobal;
		
		if(!isGlobal){
			POOLMODAL_FROMENVS = currentEnvId;
		} else {
			POOLMODAL_FROMENVS=arrayToString(getActionElementsIds($('environmentsContainter')));
		}
		//abrir modal
		showPoolsModal(processPoolsModalReturn);
	});
	 
	if(AUTH_METHOD == LDAP_METHOD && AUTH_FULL == "true"){
		var usrLogin = $('usrLogin');
		usrLogin.addClass("readonly");
		usrLogin.disabled = true;
		
		$('usrName').addClass("readonly");
		$('usrEmail').addClass("readonly");
		$('password').addClass("readonly");
		$('passwordConf').addClass("readonly");
		
		$('usrName').setAttribute('readOnly','readonly');
		$('usrEmail').setAttribute('readOnly','readonly');
		$('password').setAttribute('readOnly','readonly');
		$('passwordConf').setAttribute('readOnly','readonly');
		
		if (isCreate){
			USERMODAL_EXTERNAL = true;
			USERMODAL_SELECTONLYONE	= true;
			initUsrMdlPage();		
			$('imgSearchExt').removeClass("hidden");
			$('imgSearchExt').addEvent("click", function(e) {
				e.stop();
				showUsersModal(processUsersModalReturn);
			});
		}
	}
	
	initAdminActionsEdition();
	
	$('usrNotAct').addEvent("click", function(e) {
		var usrDescBlock = $('usrDescBlock');
		var divUsrDescBlock = $('divUsrDescBlock');
		
		if(this.checked){
			usrDescBlock.removeClass("readonly");
			usrDescBlock.readOnly = false;
			usrDescBlock.addClass("validate['required']");
			$('frmData').formChecker.register(usrDescBlock);
			divUsrDescBlock.addClass("required");
			usrDescBlock.focus();
		}else{
			divUsrDescBlock.removeClass("required");
			$('frmData').formChecker.dispose(usrDescBlock);
			usrDescBlock.removeClass("validate['required']");
			usrDescBlock.addClass("readonly");
			usrDescBlock.readOnly = true;
			usrDescBlock.value = "";
		}
	});
	
	$('usrNotAct').fireEvent("click");
	
	/*['optionDeleteDateLastLogin'].each(function(ele){
		ele = $(ele);
		ele.tooltip( ele.getAttribute("title"), { mode: 'auto', width: 100, hook: 0 });
	});*/
	
	$('usrSimPoolTypeText').readOnly = true;
	
	getBodyController().canRemoveTab = function() { return ! AT_LEAST_ON_FIELD_INPUT_CHANGED; };
	
	initEnvMdlPage();
	initPoolMdlPage();
	initPrfMdlPage();
	initAdminFav();

	initAdminFieldOnChangeHighlight();

	
}

function processUsersModalReturn(ret){
	ret.each(function(e){
		var login = e.getRowContent()[0];
		var name = e.getRowContent()[1];
		var mail = e.getRowContent()[2];
		$('usrLogin').value = login;
		$('usrName').value = name;
		$('usrEmail').value = mail;
		$('password').value = login;
		$('passwordConf').value = login;
		
	});
}

function loadEnvs(){
	var request = new Request({
		method: 'post',
		url: CONTEXT + '/apia.administration.UsersAction.run?action=getUserEnvironments' + TAB_ID_REQUEST,
		onRequest: function() { sp.show(true); },
		onComplete: function(resText, resXml) { processXMLUsrEnvs(resXml); sp.hide(true); }
	}).send();
}

function loadPools(){
	var request = new Request({
		method: 'post',
		url: CONTEXT + '/apia.administration.UsersAction.run?action=getUserPools' + TAB_ID_REQUEST,
		onRequest: function() { sp.show(true); },
		onComplete: function(resText, resXml) { processXMLUsrPools(resXml); sp.hide(true); }
	}).send();
}

function loadProfiles(){
	var request = new Request({
		method: 'post',
		url: CONTEXT + '/apia.administration.UsersAction.run?action=getUserProfiles' + TAB_ID_REQUEST,
		onRequest: function() { sp.show(true); },
		onComplete: function(resText, resXml) { processXMLUsrProfiles(resXml); sp.hide(true); }
	}).send();
}

function loadOrgRoles(){
	var request = new Request({
		method: 'post',
		url: CONTEXT + '/apia.administration.UsersAction.run?action=getUserOrgRoles' + TAB_ID_REQUEST,
		onRequest: function() { sp.show(true); },
		onComplete: function(resText, resXml) { processXMLUsrOrgRoles(resXml); sp.hide(true); }
	}).send();
}

function processXMLUsrEnvs(ajaxCallXml){
	if (ajaxCallXml != null) {
		
		var envs = ajaxCallXml.getElementsByTagName("environments");
		if (envs != null && envs.length > 0 && envs.item(0) != null) {
			envs = envs.item(0).getElementsByTagName("environment");
			for(var i = 0; i < envs.length; i++) {
				var env = envs.item(i);
				var text = env.getAttribute("text");
				var id = env.getAttribute("id");
				hideActionElement($('environmentsContainter'),"allEnvs");
				addActionElement($('environmentsContainter'),text,id,"hidEnv");
			}
		}
	}
}
	
function processXMLUsrPools(ajaxCallXml){
	if (ajaxCallXml != null) {
		
		var envs = ajaxCallXml.getElementsByTagName("pools");
		if (envs != null && envs.length > 0 && envs.item(0) != null) {
			envs = envs.item(0).getElementsByTagName("pool");
			for(var i = 0; i < envs.length; i++) {
				var env = envs.item(i);
				var text	= env.getAttribute("text");
				var id = env.getAttribute("id");
				var addRemove = true;
				if(env.getAttribute("disabled") && env.getAttribute("disabled") == "true"){
					addRemove = false;
				}
				//addActionElement($('poolsContainter'),text,id,"hidPool");
				addActionElementAdmin($('poolsContainter'), text, id, "false", addRemove, "hidPool");
			}
		}
	}
}


function processXMLUsrProfiles(ajaxCallXml){
	if (ajaxCallXml != null) {
		
		var envs = ajaxCallXml.getElementsByTagName("profiles");
		if (envs != null && envs.length > 0 && envs.item(0) != null) {
			envs = envs.item(0).getElementsByTagName("profile");
			for(var i = 0; i < envs.length; i++) {
				var env = envs.item(i);
				var text	= env.getAttribute("text");
				var id = env.getAttribute("id");
				//addActionElement($('profilesContainter'),text,id,"hidProfile");
				var addRemove = true;
				if(env.getAttribute("disabled") && env.getAttribute("disabled") == "true"){
					addRemove = false;
				}
				addActionElementAdmin($('profilesContainter'), text, id, "false", addRemove, "hidProfile");
			}
		}
	}
}

function processXMLUsrOrgRoles(ajaxCallXml){
	if (ajaxCallXml != null) {
		
		var envs = ajaxCallXml.getElementsByTagName("orgRoles");
		if (envs != null && envs.length > 0 && envs.item(0) != null) {
			envs = envs.item(0).getElementsByTagName("orgRole");
			for(var i = 0; i < envs.length; i++) {
				var env = envs.item(i);
				var text	= env.getAttribute("text");
				var id = env.getAttribute("id");
				//addActionElement($('profilesContainter'),text,id,"hidProfile");
				var addRemove = true;
				if(env.getAttribute("disabled") && env.getAttribute("disabled") == "true"){
					addRemove = false;
				}
				addActionElementAdmin($('orgRolesContainter'), text, id, "false", addRemove, "hidOrgRole");
			}
		}
	}
}

function processEnvsModalReturn(ret){
	ret.each(function(e){
		var text = e.getRowContent()[0];
		var allEnvs = $('allEnvs');
		if(allEnvs) allEnvs.setStyle("display",'none');
		addActionElement($('environmentsContainter'),text,e.getRowId(),"hidEnv");
	});
}

function processPoolsModalReturn(ret){
	ret.each(function(e){
		var text = e.getRowContent()[0];
		addActionElement($('poolsContainter'),text,e.getRowId(),"hidPool");
	});
}

function processProfilesModalReturn(ret){
	ret.each(function(e){
		var text = e.getRowContent()[0];
		addActionElement($('profilesContainter'),text,e.getRowId(),"hidProfile");
	});
}

function fieldRegExp(el){
	
	var re = new RegExp(PWD_REG_EXP);
	var str = el.value;
 
	if (re.test(str) != true) {
		el.errors.push( LBL_REG_EXP_FAIL );
		return false;
	} else {
		return true;
	}
}