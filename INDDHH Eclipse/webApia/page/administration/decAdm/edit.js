function initPage(){
	//crear spinner de espere un momento
	sp = new Spinner(document.body,{message:WAIT_A_SECOND});
		
 
	
	var optionDeleteDateLastLogin = $('optionDeleteDateLastLogin');
	optionDeleteDateLastLogin.addEvent('click', function(evt){
		$('chkResetLastLogin').value = "true";
		$('usrLastLogin').value = "";
	});
	
	$('imgUsrImage').src = CONTEXT + "/getImageServlet.run?usrLogin=" + $('usrLogin').value + "&height=24&width=24";
	
	var optionUploadImage = $('optionUploadImage');
	optionUploadImage.addEvent('click', function(e){
		e.stop();
		hideMessage();
		
		var request = new Request({
			method: 'post',
			url: CONTEXT + '/apia.administration.UsersAction.run?action=ajaxUploadStartImage&isAjax=true&' + TAB_ID_REQUEST,
			onRequest: function() { SYS_PANELS.showLoading(); },
			onComplete: function(resText, resXml) { modalProcessXml(resXml); }
		}).send();
	});
	
	
	if(isGlobal){
		//cargar ambientes
		loadEnvs();
	}
	
	//cargar grupos
	loadPools();
	//cargar perfiles
	loadProfiles();
	//cargar roles organizacionales
	loadOrgRoles();
	//cargar estilo
	loadStyles();
	
	if(isGlobal){
		$('environmentsContainter').onRemove=function(objId){
			//si al remover, no queda nada, se muestra el "todos los ambientes"
			var arr = getActionElementsIds($('environmentsContainter'));
			if(arr.length==0){
				var allEnvs = $('allEnvs');
				if(allEnvs) allEnvs.setStyle("display",'');
			}
		}
		
		$('addEnvironment').addEvent("click", function(e) {
			e.stop();
			showEnvironmentsModal(processEnvsModalReturn);
		});
	} else {
		$('envStylesContainter').onRemove = function (evt){ $('addEnvUsrStyle').show() };
	}
	
	var addProfile = $('addProfile');
	if(addProfile) {
		addProfile.addEvent("click", function(e) {
			e.stop();
			PROFILEMODAL_SHOWGLOBAL = false;
			if(!isGlobal){
				PROFILEMODAL_FROMENVS = currentEnvId;
			}else {
				PROFILEMODAL_FROMENVS=arrayToString(getActionElementsIds($('environmentsContainter')));
			}
			showProfilesModal(processProfilesModalReturn);
		});
	}
	
	
	$('addOrgRole').addEvent("click", function(e) {
		e.stop();
		
		showOrgRolesModal(processOrgRolesModalReturn);
	});
	
	var addPool = $('addPool');
	if(addPool) {
		addPool.addEvent("click", function(e) {
			e.stop();
			//setear variables de configuracion del modal de grupos
			POOLMODAL_SHOWAUTOGENERATED = false;
			POOLMODAL_SHOWNOTAUTOGENERATED = true;
			POOLMODAL_SHOWGLOBAL = false;
			POOLMODAL_ONLY_IN_HIERARCHY = false;
			POOLMODAL_ONLY_OUTSIDE_HIERARCHY = true;
			REFRESH_PARAMETERS = true;
			if(!isGlobal){
				POOLMODAL_FROMENVS = currentEnvId;
			} else {
				POOLMODAL_FROMENVS=arrayToString(getActionElementsIds($('environmentsContainter')));
			}
			//abrir modal
			showPoolsModal(processPoolsModalReturn);
		});
	}
	
	$('addHiePool').addEvent("click", function(e) {
		e.stop();
		//setear variables de configuracion del modal de grupos
		POOLMODAL_SHOWAUTOGENERATED = false;
		POOLMODAL_SHOWNOTAUTOGENERATED = true;
		POOLMODAL_SHOWGLOBAL = false;
		POOLMODAL_ONLY_IN_HIERARCHY = true;
		POOLMODAL_ONLY_OUTSIDE_HIERARCHY = false;
		REFRESH_PARAMETERS = true;
		if(!isGlobal){
			POOLMODAL_FROMENVS = currentEnvId;
		} else {
			POOLMODAL_FROMENVS=arrayToString(getActionElementsIds($('environmentsContainter')));
		}
		//abrir modal
		showPoolsModal(processHiePoolsModalReturn);
	});
	
	
	// COPIADO desde users/edit.js
	$('addEnvUsrStyle').addEvent("click", function(e) {
		e.stop();

		if (isGlobal){
			//abrir modal
			showEnvironmentsModal(processEnvUsrStylesModalReturn);	
		} else {
			//sÃ³lo se intenta agregar ambiente actual
			addEnvUsrStyleElement(currentEnvId, currentEnvName);
		}
	});
	 
	var authFullLDAP=AUTH_METHOD == LDAP_METHOD && AUTH_FULL == "true";
	if(authFullLDAP){
		var usrLogin = $('usrLogin');
		usrLogin.addClass("readonly");
		usrLogin.disabled = true;
		
		$('usrName').addClass("readonly");
		$('usrEmail').addClass("readonly");
		$('password').addClass("readonly");
		$('passwordConf').addClass("readonly");
		
		$('usrName').setAttribute('readOnly','readonly');
		$('usrEmail').setAttribute('readOnly','readonly');
		$('password').setAttribute('readOnly','readonly');
		$('passwordConf').setAttribute('readOnly','readonly');
		
		if (isCreate){
			USERMODAL_EXTERNAL = true;
			USERMODAL_SELECTONLYONE	= true;
			initUsrMdlPage();		
			$('imgSearchExt').removeClass("hidden");
			$('imgSearchExt').addEvent("click", function(e) {
				e.stop();
				showUsersModal(processUsersModalReturn);
			});	
		}
	}
	
	initAdminActionsEdition();
	
	if(!authFullLDAP){
		setPasswordRequired(isCreate);
		if (!isCreate){
			$('password').addEvent('keyup', function(){
				setPasswordRequired(this.value!="");
			})
		}
	}
	
	
	$('usrNotAct').addEvent("click", function(e) {
		var usrDescBlock = $('usrDescBlock');
		var divUsrDescBlock = $('divUsrDescBlock');
		
		if(this.checked){
			usrDescBlock.removeClass("readonly");
			usrDescBlock.readOnly = false;
			usrDescBlock.addClass("validate['required']");
			$('frmData').formChecker.register(usrDescBlock);
			divUsrDescBlock.addClass("required");
			usrDescBlock.focus();
		}else{
			divUsrDescBlock.removeClass("required");
			$('frmData').formChecker.dispose(usrDescBlock);
			usrDescBlock.removeClass("validate['required']");
			usrDescBlock.addClass("readonly");
			usrDescBlock.readOnly = true;
			usrDescBlock.value = "";
		}
	});
	
	$('usrNotAct').fireEvent("click");
	$('usrSimPoolTypeText').readOnly = true;
	
	getBodyController().canRemoveTab = function() { return ! AT_LEAST_ON_FIELD_INPUT_CHANGED; };
	
	initEnvMdlPage();
	initPoolMdlPage();
	initPrfMdlPage();
	initOrgRoleMdlPage();
	initAdminFav();
	initStyMdlPage();

	initAdminFieldOnChangeHighlight();

	$('frmData').formChecker.options.display.titlesInsteadNames = 1;
}

function setPasswordRequired(enable){
	var pwd = $('password');
	var pwdConf = $('passwordConf');
		
	if (pwd && pwdConf){
		var pwdContainer = pwd.getParent('div');
		var pwdConfContainer = pwdConf.getParent('div');
		var frmCheck = $('frmData').formChecker;
		
		if (enable){
			pwd.addClass("validate['required','~fieldRegExp']");
			pwdConf.removeAttribute("class");
			pwdConf.removeAttribute('readOnly','readonly');
			pwdConf.addClass("validate['required','confirm:password']");
			frmCheck.register(pwd);
			frmCheck.register(pwdConf);
			
			if (pwdContainer) pwdContainer.addClass('required');
			if (pwdConfContainer) pwdConfContainer.addClass('required');
			
		} else {
			pwd.setAttribute('placeholder', LBL_MODIFY_PWD);
			pwd.removeAttribute("class");
			pwdConf.removeAttribute("class");
			frmCheck.dispose(pwd);
			frmCheck.dispose(pwdConf);
						
			pwdConf.addClass("readonly");			
			pwdConf.setAttribute('readOnly','readonly');
			
			if (pwdContainer) pwdContainer.removeClass('required');
			if (pwdConfContainer) pwdConfContainer.removeClass('required');
		}		
	}
}

function processUsersModalReturn(ret){
	ret.each(function(e){
		var login = e.getRowContent()[0];
		var name = e.getRowContent()[1];
		var mail = e.getRowContent()[2];
		$('usrLogin').value = login;
		$('usrName').value = name;
		$('usrEmail').value = mail;
		$('password').value = login;
		$('passwordConf').value = login;
		
	});
}

function loadEnvs(){
	var request = new Request({
		method: 'post',
		url: CONTEXT + '/apia.administration.UsersAction.run?action=getUserEnvironments&isAjax=true' + TAB_ID_REQUEST,
		onRequest: function() { sp.show(true); },
		onComplete: function(resText, resXml) { processXMLUsrEnvs(resXml); sp.hide(true); }
	}).send();
}

function loadPools(){
	var request = new Request({
		method: 'post',
		url: CONTEXT + '/apia.administration.UsersAction.run?action=getUserPools&disableHie=true&isAjax=true' + TAB_ID_REQUEST,
		onRequest: function() { sp.show(true); },
		onComplete: function(resText, resXml) { 
			processXMLUsrPools(resXml); sp.hide(true);
			initAdminModalHandlerOnChangeHighlight($('hiePoolsContainter'));
		}
	}).send();
}

function loadProfiles(){
	var request = new Request({
		method: 'post',
		url: CONTEXT + '/apia.administration.UsersAction.run?action=getUserProfiles&disableHie=true&isAjax=true' + TAB_ID_REQUEST,
		onRequest: function() { sp.show(true); },
		onComplete: function(resText, resXml) { processXMLUsrProfiles(resXml); sp.hide(true); }
	}).send();
}

function loadOrgRoles(){
	var request = new Request({
		method: 'post',
		url: CONTEXT + '/apia.administration.UsersAction.run?action=getUserOrgRoles&isAjax=true' + TAB_ID_REQUEST,
		onRequest: function() { sp.show(true); },
		onComplete: function(resText, resXml) { 
			processXMLUsrOrgRoles(resXml); sp.hide(true);
			initAdminModalHandlerOnChangeHighlight($('orgRolesContainter'));
		}
	}).send();
}

function loadStyles(){
	var request = new Request({
		method: 'post',
		url: CONTEXT + '/apia.administration.UsersAction.run?action=getUserStyles&isAjax=true' + TAB_ID_REQUEST,
		onRequest: function() { sp.show(true); },
		onComplete: function(resText, resXml) { processXMLUsrStyles(resXml); sp.hide(true); }
	}).send();
}

function processXMLUsrEnvs(ajaxCallXml){
	if (ajaxCallXml != null) {
		
		var envs = ajaxCallXml.getElementsByTagName("environments");
		if (envs != null && envs.length > 0 && envs.item(0) != null) {
			envs = envs.item(0).getElementsByTagName("environment");
			for(var i = 0; i < envs.length; i++) {
				var env = envs.item(i);
				var text = env.getAttribute("text");
				var id = env.getAttribute("id");
				hideActionElement($('environmentsContainter'),"allEnvs");
				addActionElement($('environmentsContainter'),text,id,"hidEnv");
			}
		}
	}
}
	
function processXMLUsrPools(ajaxCallXml){
	if (ajaxCallXml != null) {
		
		var envs = ajaxCallXml.getElementsByTagName("pools");
		if (envs != null && envs.length > 0 && envs.item(0) != null) {
			envs = envs.item(0).getElementsByTagName("pool");
			for(var i = 0; i < envs.length; i++) {
				var env = envs.item(i);
				var text	= env.getAttribute("text");
				var id = env.getAttribute("id");
				var addRemove = true;
				if(env.getAttribute("disabled") && env.getAttribute("disabled") == "true"){
					addRemove = false;
				}
				if(env.getAttribute("hierarchy"))
					addActionElementAdmin($('hiePoolsContainter'), text, id, "false", addRemove, "hidPool");
				else
					addActionElementAdmin($('poolsContainter'), text, id, "false", addRemove, "hidPool");
			}
		}
	}
}


function processXMLUsrProfiles(ajaxCallXml){
	if (ajaxCallXml != null) {
		
		var envs = ajaxCallXml.getElementsByTagName("profiles");
		if (envs != null && envs.length > 0 && envs.item(0) != null) {
			envs = envs.item(0).getElementsByTagName("profile");
			for(var i = 0; i < envs.length; i++) {
				var env = envs.item(i);
				var text	= env.getAttribute("text");
				var id = env.getAttribute("id");
				var addRemove = true;
				if(env.getAttribute("disabled") && env.getAttribute("disabled") == "true"){
					addRemove = false;
				}
				addActionElementAdmin($('profilesContainter'), text, id, "false", addRemove, "hidProfile");
			}
		}
	}
}

function processXMLUsrOrgRoles(ajaxCallXml){
	if (ajaxCallXml != null) {
		
		var envs = ajaxCallXml.getElementsByTagName("orgRoles");
		if (envs != null && envs.length > 0 && envs.item(0) != null) {
			envs = envs.item(0).getElementsByTagName("orgRole");
			for(var i = 0; i < envs.length; i++) {
				var env = envs.item(i);
				var text	= env.getAttribute("text");
				var id = env.getAttribute("id");
				var addRemove = true;
				if(env.getAttribute("disabled") && env.getAttribute("disabled") == "true"){
					addRemove = false;
				}
				addActionElementAdmin($('orgRolesContainter'), text, id, "false", addRemove, "hidOrgRole");
			}
		}
	}
}

function processXMLUsrStyles(ajaxCallXml){
	if (ajaxCallXml != null) {
		
		var styles = ajaxCallXml.getElementsByTagName("styles");
		if (styles != null && styles.length > 0 && styles.item(0) != null) {
			styles = styles.item(0).getElementsByTagName("style");
			for(var i = 0; i < styles.length; i++) {
				var style = styles.item(i);
				var text  = style.getAttribute("text");
				var id 	  = style.getAttribute("id");
				var defaultStyle = style.getAttribute("defaultStyle");
				addEnvUsrStyleElement(id, text, defaultStyle);
			}
		}
	}
}

function processEnvsModalReturn(ret){
	ret.each(function(e){
		var text = e.getRowContent()[0];
		var allEnvs = $('allEnvs');
		if(allEnvs) allEnvs.setStyle("display",'none');
		addActionElement($('environmentsContainter'),text,e.getRowId(),"hidEnv");
	});
}

function processPoolsModalReturn(ret){
	ret.each(function(e){
		var text = e.getRowContent()[0];
		addActionElement($('poolsContainter'),text,e.getRowId(),"hidPool");
	});
}

function processHiePoolsModalReturn(ret){
	ret.each(function(e){
		var text = e.getRowContent()[0];
		addActionElement($('hiePoolsContainter'),text,e.getRowId(),"hidPool");
	});
}

function processProfilesModalReturn(ret){
	ret.each(function(e){
		var text = e.getRowContent()[0];
		addActionElement($('profilesContainter'),text,e.getRowId(),"hidProfile");
	});
}

function processOrgRolesModalReturn(ret){
	ret.each(function(e){
		var text = e.getRowContent()[0];
		addActionElement($('orgRolesContainter'),text,e.getRowId(),"hidOrgRole");
	});
}

function processEnvUsrStylesModalReturn(ret){
	ret.each(function(e){
		var env = e.getRowContent()[0];
		
		addEnvUsrStyleElement(e.getRowId(), env);
	});
}

// COPIADO desde users/edit.js
function addEnvUsrStyleElement(id, env, style){
	var editable = isGlobal || id == currentEnvId;
	var content = addActionElementAdmin($('envStylesContainter'),env,id,"false", editable, "envUsrStyle");
	if (content == null) return;
	new Element('span.checkcontainer', {html: ' ' + LBL_DEFAULT_STYLE + ': '}).inject(content);
	var combobox = $('usrStyles').clone().inject(content);
	combobox.removeAttribute('style');
	combobox.name = 'comboDefaultStyle' + id;
	
	if (style){
		for(var i=0; i<combobox.options.length; i++){ 
			if (combobox.options[i].textContent==style){
				combobox.selectedIndex = i;
				break;
			}
		}
	}
	
	if (!isGlobal){
		if (!editable) { 
			combobox.disabled=true; 
			combobox.addClass("readonly"); 
		} else {
			$('addEnvUsrStyle').hide(); 
		}	
	}	
}

function fieldRegExp(el){
	
	var re = new RegExp(PWD_REG_EXP);
	var str = el.value;
 
	if (re.test(str) != true) {
		el.errors.push( LBL_REG_EXP_FAIL );
		return false;
	} else {
		return true;
	}
}

         
function ajaxUploadCallStatusUrlImage() {
	new Request({
		method: 'post',
		url: CONTEXT + URL_REQUEST_AJAX + "?action=ajaxUploadFileStatusImage&isAjax=true" + TAB_ID_REQUEST,
		onComplete: function(resText, resXml) {
			modalProcessXml(resXml); }
		}).send();
}

function setFileName(){
	 var ajaxCallXml = getLastFunctionAjaxCall();
	 if (ajaxCallXml != null) {
		 var messages = ajaxCallXml.getElementsByTagName("messages");
		 if (messages != null && messages.length > 0 && messages.item(0) != null) {
			 messages = messages.item(0).getElementsByTagName("message");
			 var message = messages.item(0);
			 if (message.firstChild != null) text = message.firstChild.nodeValue;
			 var id = text;
			 //$('txtUpload').value=fileName;
			 $('imgUsrImage').src = CONTEXT + "/getImageServlet.run?path=" + id + "&height=100&width=100";
		 }
	 }
	 SYS_PANELS.closeAll();
}


