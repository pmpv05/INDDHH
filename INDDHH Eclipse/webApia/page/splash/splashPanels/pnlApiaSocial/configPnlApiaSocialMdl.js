var spModalConfigPnlApiaSocial;

var MAX_PARAMETER_SIZE = 255;

function initConfigPnlApiaSocialMdl(){
	var mdlConfigPnlApiaSocialContainer = $('mdlConfigPnlApiaSocialContainer');
	if (mdlConfigPnlApiaSocialContainer.initDone) return;
	mdlConfigPnlApiaSocialContainer.initDone = true;

	mdlConfigPnlApiaSocialContainer.blockerModal = new Mask();
	
	spModalConfigPnlApiaSocial = new Spinner($('mdlBodyConfigPnlApiaSocial'),{message:WAIT_A_SECOND});
	
	$('addEnvironment').addEvent("click",function(e){
		e.stop();
		ENVIRONMENTMODAL_SELECTONLYONE = false;
		var filterIn = $('paramChnEnvAva').value;		
		ENVIRONMENTMODAL_ADT_SQL = filterIn != '' && filterIn != null ? ' env_id_auto in (' + filterIn + ')' : '';
		showEnvironmentsModal(processRetMdlEnvironment);
	});
	
	$('addProcess').addEvent("click",function(e){
		e.stop();
		PROCESSMODAL_SHOWGLOBAL = false;
		PROCESSMODAL_SELECTONLYONE = false;
		PROCESSMODAL_IS_SCENARIO = false;
		PROCESSMODAL_SHOW_ALL = false;
		var filterIn = $('paramChnProAva').value;		
		PROCESSMODAL_ADT_SQL = filterIn != '' && filterIn != null ? ' AND pro_id_auto in (' + filterIn + ')' : '';
		showProcessModal(processRetMdlProcess);
	});
	
	$('addTask').addEvent("click",function(e){
		e.stop();
		TASKMODAL_SELECTONLYONE = false;
		var filterIn = $('paramChnTskAva').value;		
		TASKMODAL_ADT_SQL = filterIn != '' && filterIn != null ? ' AND tsk_id_auto in (' + filterIn + ')' : '';
		showTaskModal(processRetMdlTask);
	});
	
	$('addPool').addEvent("click",function(e){
		e.stop();
		POOLMODAL_SHOWAUTOGENERATED = true;
		POOLMODAL_SHOWNOTAUTOGENERATED = true;
		POOLMODAL_FROMENVS = "";
		POOLMODAL_SHOWCURRENTENV = false;
		POOLMODAL_SHOWGLOBAL = true;
		POOLMODAL_EXACTMATCH = ""; 
		POOLMODAL_SELECTONLYONE	= false;
		POOLMODAL_FOR_HIERARCHY = false;
		showPoolsModal(processRetMdlPool);
	});
	
	$('addUser').addEvent("click",function(e){
		e.stop();
		USERMODAL_EXTERNAL = false;
		USERMODAL_SELECTONLYONE	= false;
		USERMODAL_GLOBAL_AND_ENV = true;
		showUsersModal(processRetMdlUser);
	});
	
	$('closeConfigPnlApiaSocialMdl').addEvent("click", function(e) {
		e.stop();
		closeConfigPnlApiaSocialMdl(true);
	});
	
	$('chnEnvContainer').onRemove = function() {
		maxParamEnv = false;
	};
	$('chnProContainer').onRemove = function() {
		maxParamPro = false;
	};
	$('chnTskContainer').onRemove = function() {
		maxParamTsk = false;
	};
	$('chnPoolContainer').onRemove = function() {
		maxParamPool = false;
	};
	$('chnUsrContainer').onRemove = function() {
		maxParamUsr = false;
	};
	
	$('btnConfirmConfigPnlApiaSocialMdl').addEvent("click", function(e){
		e.stop();
		var mdlConfigPnlApiaSocialContainer = $('mdlConfigPnlApiaSocialContainer');
		if (mdlConfigPnlApiaSocialContainer.onModalConfirm){
			var paramRefreshTime = $('paramRefreshTime').value;
			if (paramRefreshTime != '' && Number.from(paramRefreshTime) < MIN_REFRESH_TIME){
				showMessage(MSG_MIN_REFRESH.replace("<TOK1>",MIN_REFRESH_TIME), GNR_TIT_WARNING, 'modalWarning');
				return;
			}			
			var paramViewMode = $('paramViewMode').value;
			var paramDays = $('paramDays').value;			
			var paramChnEnv = '';
			$('chnEnvContainer').getElements("div.optionRemove").each(function(chn){
				if (paramChnEnv != '') paramChnEnv += PARAM_SEPARATOR;
				paramChnEnv += chn.getParent().getAttribute("objId");
			});
			var paramChnPro = '';
			$('chnProContainer').getElements("div.optionRemove").each(function(chn){
				if (paramChnPro != '') paramChnPro += PARAM_SEPARATOR;
				paramChnPro += chn.getParent().getAttribute("objId");
			});
			var paramChnTsk = '';
			$('chnTskContainer').getElements("div.optionRemove").each(function(chn){
				if (paramChnTsk != '') paramChnTsk += PARAM_SEPARATOR;
				paramChnTsk += chn.getParent().getAttribute("objId");
			});
			var paramChnPool = '';
			$('chnPoolContainer').getElements("div.optionRemove").each(function(chn){
				if (paramChnPool != '') paramChnPool += PARAM_SEPARATOR;
				paramChnPool += chn.getParent().getAttribute("objId");
			});
			var paramChnUsr = '';
			$('chnUsrContainer').getElements("div.optionRemove").each(function(chn){
				if (paramChnUsr != '') paramChnUsr += PARAM_SEPARATOR;
				paramChnUsr += chn.getParent().getAttribute("objId");
			});
						
			var newConfig = {
				'paramRefreshTime': paramRefreshTime,
				'paramViewMode': paramViewMode,
				'paramDays': paramDays,
				'paramChnEnv': paramChnEnv,
				'paramChnPro': paramChnPro,
				'paramChnTsk': paramChnTsk,
				'paramChnPool': paramChnPool,
				'paramChnUsr': paramChnUsr
			};
			jsCaller(mdlConfigPnlApiaSocialContainer.onModalConfirm,newConfig);
		}			
		closeConfigPnlApiaSocialMdl(false);
	});
	
	//Modales
	initEnvMdlPage();
	initProcMdlPage();
	initTaskMdlPage();
	initPoolMdlPage();
	initUsrMdlPage();
}


function showConfigPnlApiaSocialMdl(objParams,retFunction,closeFunction){
	var mdlConfigPnlApiaSocialContainer = $('mdlConfigPnlApiaSocialContainer');
	mdlConfigPnlApiaSocialContainer.removeClass('hiddenModal');
	mdlConfigPnlApiaSocialContainer.blockerModal.show();
	mdlConfigPnlApiaSocialContainer.setStyle('zIndex', SYS_PANELS.getNewZIndex());
	mdlConfigPnlApiaSocialContainer.objParams = objParams;
	mdlConfigPnlApiaSocialContainer.onModalConfirm = retFunction;
	mdlConfigPnlApiaSocialContainer.onModalClose = closeFunction;
	
	spModalConfigPnlApiaSocial.show(true);
	cleanModal();	
	setModal(objParams);
	mdlConfigPnlApiaSocialContainer.position();
	spModalConfigPnlApiaSocial.hide(true);
}

function cleanModal(){
	$('paramRefreshTime').value = '';
	$('paramViewMode').selectedIndex = 0;
	$('paramDays').value = '';
	$('chnEnvContainer').getElements("div.optionRemove").each(function(chn){ chn.click(); });
	$('paramChnEnvAva').value = '';
	$('chnProContainer').getElements("div.optionRemove").each(function(chn){ chn.click(); });
	$('paramChnProAva').value = '';
	$('chnTskContainer').getElements("div.optionRemove").each(function(chn){ chn.click(); });
	$('paramChnTskAva').value = '';
	$('chnPoolContainer').getElements("div.optionRemove").each(function(chn){ chn.click(); });
	$('chnUsrContainer').getElements("div.optionRemove").each(function(chn){ chn.click(); });	
	
	maxParamEnv = false;
	maxParamPro = false;
	maxParamTsk = false;
	maxParamPool = false;
	maxParamUsr = false;
}

function setModal(objParams){
	if (objParams){
		$('paramRefreshTime').value = objParams.paramRefreshTime;
		$('paramViewMode').value = objParams.paramViewMode;
		$('paramDays').value = objParams.paramDays;
		$('paramChnEnvAva').value = objParams.paramChnEnvAva;
		for (var i = 0; i < objParams.paramChnEnv.length; i++){
			var objId = objParams.paramChnEnv[i].objId;
			var element = addActionElement($('chnEnvContainer'), objParams.paramChnEnv[i].text, 'env_' + objId, "hidSocialEnv");
			element.set("objId", objId);
		}
		$('paramChnProAva').value = objParams.paramChnProAva;
		for (var i = 0; i < objParams.paramChnPro.length; i++){
			var objId = objParams.paramChnPro[i].objId;			
			var element = addActionElement($('chnProContainer'), objParams.paramChnPro[i].text, 'pro_'+objId, "hidSocialPro");
			element.set("objId", objId);
		}
		$('paramChnTskAva').value = objParams.paramChnTskAva;
		for (var i = 0; i < objParams.paramChnTsk.length; i++){
			var objId = objParams.paramChnTsk[i].objId;
			var element = addActionElement($('chnTskContainer'), objParams.paramChnTsk[i].text, 'tsk_'+objId, "hidSocialTsk");
			element.set("objId", objId);
		}
		for (var i = 0; i < objParams.paramChnPool.length; i++){
			var objId = objParams.paramChnPool[i].objId;
			var element = addActionElement($('chnPoolContainer'), objParams.paramChnPool[i].text, 'pool_'+objId, "hidSocialPool");
			element.set("objId", objId);
		}
		for (var i = 0; i < objParams.paramChnUsr.length; i++){
			var objId = objParams.paramChnUsr[i].objId;
//			var chn = new Element("div.option.optionRemove",{'id':'usr_'+objId, html: objParams.paramChnUsr[i].text}).inject($('addUser'),"before");
//			chn.setAttribute("objId",objId);
//			chn.addEvent("click",function(e){ this.destroy(); });
			var element = addActionElement($('chnUsrContainer'), objParams.paramChnUsr[i].text, 'usr_'+objId, "hidSocialUsr");
			element.set("objId", objId);
		}
	}
}

function closeConfigPnlApiaSocialMdl(callFnc){
    var mdlConfigPnlApiaSocialContainer = $('mdlConfigPnlApiaSocialContainer');
    mdlConfigPnlApiaSocialContainer.addClass('hiddenModal');
    mdlConfigPnlApiaSocialContainer.blockerModal.hide();
    if (callFnc && mdlConfigPnlApiaSocialContainer.onModalClose) mdlConfigPnlApiaSocialContainer.onModalClose();
}

function processRetMdlEnvironment(ret){
	for (var i = 0; i < ret.length; i++){
		var env = ret[i];
		var id = env.getRowId();
		if (!$('env_'+id)){
			if (paramExcededSize('E', id)){
				showParamSizeExceded('E');
				return;
			} else {
				var element = addActionElement($('chnEnvContainer'), env.getRowContent()[0], 'env_'+id, "hidSocialEnv");
				element.set("objId", id);
			}			
		}
	}	
}

function processRetMdlProcess(ret){
	for (var i = 0; i < ret.length; i++){
		var pro = ret[i];
		var id = pro.getRowId();
		if (!$('pro_'+id)){
			if (paramExcededSize('P', id)){
				showParamSizeExceded('P');
				return;
			} else {				
				var element = addActionElement($('chnProContainer'), pro.getRowContent()[0], 'pro_'+id, "hidSocialPro");
				element.set("objId", id);
			}			
		}
	}	
}

function processRetMdlTask(ret){
	for (var i = 0; i < ret.length; i++){
		var tsk = ret[i];
		var id = tsk.getRowId();
		if (!$('tsk_'+id)){
			if (paramExcededSize('T', id)){
				showParamSizeExceded('T');
				return;
			} else {
				var element = addActionElement($('chnTskContainer'), tsk.getRowContent()[0], 'tsk_'+id, "hidSocialTsk");
				element.set("objId", id);
			}			
		}
	}	
}

function processRetMdlPool(ret){
	for (var i = 0; i < ret.length; i++){
		var pool = ret[i];
		var id = pool.getRowId();
		if (!$('pool_'+id)){
			if (paramExcededSize('G', id)){
				showParamSizeExceded('G');
				return;
			} else {
				var element = addActionElement($('chnPoolContainer'), pool.getRowContent()[0], 'pool_'+id, "hidSocialPool");
				element.set("objId", id);
			}			
		}
	}	
}

function processRetMdlUser(ret){
	for (var i = 0; i < ret.length; i++){
		var usr = ret[i];
		var id = usr.getRowId();
		if (!$('usr_'+id)){
			if (paramExcededSize('U', id)){
				showParamSizeExceded('U');
				return;
			} else {
				var element = addActionElement($('chnUsrContainer'), usr.getRowContent()[0], 'usr_'+id, "hidSocialUsr");
				element.set("objId", id);
			}			
		}
	}		
}

function paramExcededSize(type,newValue){
	var str = '';
	var container = null;
	if (type == 'E'){
		container = $('chnEnvContainer');
	} else if (type == 'P'){
		container = $('chnProContainer');
	} else if (type == 'T'){
		container = $('chnTskContainer');
	} else if (type == 'G'){
		container = $('chnPoolContainer');
	} else if (type == 'U'){
		container = $('chnUsrContainer');
	}
	if (container != null){
		container.getElements("div.optionRemove").each(function(e){
			if (str != '') str += PARAM_SEPARATOR;
			str += e.getParent().getAttribute("objId");
		});
	}
	if (newValue != null){
		if (str != '') str += PARAM_SEPARATOR;
		str += newValue;
	}
	
	return str.length >= MAX_PARAMETER_SIZE;
}

function showParamSizeExceded(type){
	var lblType = '';
	if (type == 'E'){
		lblType = LBL_ENV;		 
	} else if (type == 'P'){
		lblType = LBL_PRO;		
	} else if (type == 'T'){
		lblType = LBL_TSK;		
	} else if (type == 'G'){
		lblType = LBL_POOL;		
	} else if (type == 'U'){
		lblType = LBL_USR;
	}
	showMessage(MSG_MAX_PAR_SIZE.replace("<TOK1>",lblType), GNR_TIT_WARNING, 'modalWarning');
}
